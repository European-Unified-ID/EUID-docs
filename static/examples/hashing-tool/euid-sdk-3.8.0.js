(()=>{"use strict";var e={480:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isOptoutIdentity=t.isValidIdentity=void 0,t.isValidIdentity=function(e){return"object"==typeof e&&null!==e&&"advertising_token"in e&&"identity_expires"in e&&"refresh_from"in e&&"refresh_token"in e&&"refresh_expires"in e},t.isOptoutIdentity=function(e){return null!==e&&"object"==typeof e&&"optout"===e.status}},31:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiClient=void 0;const r=i(621),s=i(480),o=i(220),a=i(28),l=i(332),d=i(221);t.ApiClient=class{constructor(e,t,i){var n;this._requestsInFlight=[],this._baseUrl=null!==(n=e.baseUrl)&&void 0!==n?n:t,this._productName=i,this._clientVersion=i.toLowerCase()+"-sdk-"+r.SdkBase.VERSION}hasActiveRequests(){return this._requestsInFlight.length>0}updateBaseUrl(e){this._baseUrl=e}ResponseToRefreshResult(e){return function(e){return!!function(e){return"object"==typeof e&&null!==e&&"status"in e}(e)&&("optout"===e.status||"expired_token"===e.status||"success"===e.status&&"body"in e&&(0,s.isValidIdentity)(e.body))}(e)?"success"===e.status?{status:e.status,identity:e.body}:e:"Response didn't contain a valid status"}abortActiveRequests(){this._requestsInFlight.forEach((e=>{e.abort()})),this._requestsInFlight=[]}callRefreshApi(e){const t=this._baseUrl+"/v2/token/refresh",i=new XMLHttpRequest;let n,r;this._requestsInFlight.push(i),i.overrideMimeType("text/plain"),i.open("POST",t,!0),i.setRequestHeader("X-UID2-Client-Version",this._clientVersion);const s=new Promise(((e,t)=>{n=e,r=t}));return i.onreadystatechange=()=>{if(i.readyState===i.DONE){this._requestsInFlight=this._requestsInFlight.filter((e=>e!==i));try{if(e.refresh_response_key&&200===i.status){const t=(0,d.base64ToBytes)(i.responseText);window.crypto.subtle.importKey("raw",(0,d.base64ToBytes)(e.refresh_response_key),{name:"AES-GCM"},!1,["decrypt"]).then((e=>{window.crypto.subtle.decrypt({name:"AES-GCM",iv:t.slice(0,12),tagLength:128},e,t.slice(12)).then((e=>{const t=String.fromCharCode(...new Uint8Array(e)),i=JSON.parse(t),s=this.ResponseToRefreshResult(i);"string"==typeof s?r(s):n(s)}),(e=>r(`Call to ${this._productName} API failed: `+e)))}),(e=>r(`Call to ${this._productName} API failed: `+e)))}else{const e=JSON.parse(i.responseText),t=this.ResponseToRefreshResult(e);"string"==typeof t?r(t):n(t)}}catch(e){r(e)}}},i.send(e.refresh_token),s}callCstgApi(e,t){return n(this,void 0,void 0,(function*(){const i="emailHash"in e?{email_hash:e.emailHash}:{phone_hash:e.phoneHash},r=yield o.CstgBox.build((0,l.stripPublicKeyPrefix)(t.serverPublicKey)),c=new TextEncoder,u=Date.now(),{iv:h,ciphertext:p}=yield r.encrypt(c.encode(JSON.stringify(i)),c.encode(JSON.stringify([u]))),y=yield(0,a.exportPublicKey)(r.clientPublicKey),f={payload:(0,d.bytesToBase64)(new Uint8Array(p)),iv:(0,d.bytesToBase64)(new Uint8Array(h)),public_key:(0,d.bytesToBase64)(new Uint8Array(y)),timestamp:u,subscription_id:t.subscriptionId},g=this._baseUrl+"/v2/token/client-generate",_=new XMLHttpRequest;let v,b;this._requestsInFlight.push(_),_.overrideMimeType("text/plain"),_.open("POST",g,!0);const m=new Promise(((e,t)=>{v=e,b=t}));return _.onreadystatechange=()=>n(this,void 0,void 0,(function*(){if(_.readyState===_.DONE){this._requestsInFlight=this._requestsInFlight.filter((e=>e!==_));try{if(200===_.status){const e=(0,d.base64ToBytes)(_.responseText),t=yield r.decrypt(e.slice(0,12),e.slice(12)),i=(new TextDecoder).decode(t),n=JSON.parse(i);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"success"===t.status&&(0,s.isValidIdentity)(t.body)}(n)?function(e){return null!==e&&"object"==typeof e&&"optout"===e.status}(n)?v({status:"optout"}):b(`API error: Response body was invalid for HTTP status 200: ${i}`):v({status:"success",identity:n.body})}else if(400===_.status){const e=JSON.parse(_.responseText);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"client_error"===t.status&&"string"==typeof t.message}(e)?b(`API error: Response body was invalid for HTTP status 400: ${_.responseText}`):b(`Client error: ${e.message}`)}else if(403===_.status){const e=JSON.parse(_.responseText);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"invalid_http_origin"===t.status&&"string"==typeof t.message}(e)?b(`API error: Response body was invalid for HTTP status 403: ${_.responseText}`):b(`Forbidden: ${e.message}`)}else b(`API error: Unexpected HTTP status ${_.status}`)}catch(e){b(e)}}})),_.send(JSON.stringify(f)),yield m}))}}},566:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.CallbackManager=t.EventType=void 0,function(e){e.InitCompleted="InitCompleted",e.IdentityUpdated="IdentityUpdated",e.SdkLoaded="SdkLoaded",e.OptoutReceived="OptoutReceived"}(i||(t.EventType=i={}));class n{constructor(e,t,i,n){this._sentInit=!1,this._productName=t,this._logger=n,this._getIdentity=i,this._sdk=e,this._sdk.callbacks.push=this.callbackPushInterceptor.bind(this)}callbackPushInterceptor(...e){var t;for(const r of e)n._sentSdkLoaded[this._productName]&&this.safeRunCallback(r,i.SdkLoaded,{}),this._sentInit&&this.safeRunCallback(r,i.InitCompleted,{identity:null!==(t=this._getIdentity())&&void 0!==t?t:null});return Array.prototype.push.apply(this._sdk.callbacks,e)}runCallbacks(e,t){var r;if(e===i.InitCompleted&&(this._sentInit=!0),e===i.SdkLoaded&&(n._sentSdkLoaded[this._productName]=!0),!this._sentInit&&e!==i.SdkLoaded)return;const s=Object.assign(Object.assign({},t),{identity:null!==(r=this._getIdentity())&&void 0!==r?r:null});for(const t of this._sdk.callbacks)this.safeRunCallback(t,e,s)}safeRunCallback(e,t,i){if("function"==typeof e)try{e(t,i)}catch(e){this._logger.warn("SDK callback threw an exception",e)}else this._logger.warn("An SDK callback was supplied which isn't a function.")}}t.CallbackManager=n,n._sentSdkLoaded={}},332:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isClientSideIdentityOptionsOrThrow=t.stripPublicKeyPrefix=void 0,t.stripPublicKeyPrefix=function(e){return e.substring(9)},t.isClientSideIdentityOptionsOrThrow=function(e,t="UID2"){if("object"!=typeof e||null===e)throw new TypeError("opts must be an object");const i=e;if("string"!=typeof i.serverPublicKey)throw new TypeError("opts.serverPublicKey must be a string");const n=new RegExp(`^${t}-X-[A-Z]-.+`);if(!n.test(i.serverPublicKey))throw new TypeError(`opts.serverPublicKey must match the regular expression ${n}`);if("string"!=typeof i.subscriptionId)throw new TypeError("opts.subscriptionId must be a string");if(0===i.subscriptionId.length)throw new TypeError("opts.subscriptionId is empty");return!0}},605:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeConfig=t.updateConfig=t.loadConfig=t.storeConfig=void 0;const i=e=>({refreshRetryPeriod:e.refreshRetryPeriod,baseUrl:e.baseUrl,useCookie:e.useCookie,cookiePath:e.cookiePath,cookieDomain:e.cookieDomain});t.storeConfig=(e,t)=>{e.useCookie?n(e,t):o(e,t)},t.loadConfig=e=>s(e)||l(e),t.updateConfig=(e,i,n)=>{(0,t.removeConfig)(n,i),(0,t.storeConfig)(e,i)},t.removeConfig=(e,t)=>{e.useCookie?r(e,t):a(t)};const n=(e,t)=>{var n;const r=e.cookieDomain,s=null!==(n=e.cookiePath)&&void 0!==n?n:"/",o=JSON.stringify(i(e));let a=t.cookieName+"_config="+encodeURIComponent(o)+" ;path="+s;void 0!==r&&(a+=";domain="+r),document.cookie=a},r=(e,t)=>{var i,n;document.cookie=t.cookieName+"_config=;path="+(null!==(i=e.cookiePath)&&void 0!==i?i:"/")+";domain="+(null!==(n=e.cookieDomain)&&void 0!==n?n:"")+";expires=Tue, 1 Jan 1980 23:59:59 GMT"},s=e=>{const t=(e=>{const t=document.cookie;if(t){const i=t.split("; ").find((t=>t.startsWith(e.cookieName+"_config=")));if(i)return decodeURIComponent(i.split("=")[1])}})(e);return t?JSON.parse(t):null},o=(e,t)=>{const n=JSON.stringify(i(e));localStorage.setItem(t.localStorageKey+"_config",n)},a=e=>{localStorage.removeItem(e.localStorageKey+"_config")},l=e=>{const t=localStorage.getItem(e.localStorageKey+"_config");return t?JSON.parse(t):null}},305:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CookieManager=t.loadIdentityFromCookieNoLegacy=t.isLegacyCookie=void 0;const n=i(480);function r(e){if("object"!=typeof e||!e)return!1;const t=e;return!!("advertising_token"in t&&"refresh_token"in t&&t.advertising_token&&t.refresh_token)}function s(e){const t=document.cookie;if(t){const i=t.split("; ").find((t=>t.startsWith(e+"=")));if(i)return decodeURIComponent(i.split("=")[1])}}t.isLegacyCookie=r,t.loadIdentityFromCookieNoLegacy=function(e){const t=s(e);if(t){const e=JSON.parse(t);if((0,n.isValidIdentity)(e))return e;if((0,n.isOptoutIdentity)(e))return e}return null},t.CookieManager=class{constructor(e,t){this._cookieName=t,this._opts=e}setCookie(e){var t;const i=JSON.stringify(e),n=new Date(e.refresh_expires),r=null!==(t=this._opts.cookiePath)&&void 0!==t?t:"/";let s=this._cookieName+"="+encodeURIComponent(i)+" ;path="+r+";expires="+n.toUTCString();void 0!==this._opts.cookieDomain&&(s+=";domain="+this._opts.cookieDomain),document.cookie=s}removeCookie(e){var t,i;document.cookie=this._cookieName+"=;path="+(null!==(t=e.cookiePath)&&void 0!==t?t:"/")+";domain="+(null!==(i=e.cookieDomain)&&void 0!==i?i:"")+";expires=Tue, 1 Jan 1980 23:59:59 GMT"}migrateLegacyCookie(e,t){const i=function(e,t){return Object.assign({refresh_from:t,refresh_expires:t+6048e5,identity_expires:t+144e5},e)}(e,t);return this.setCookie(i),i}loadIdentityFromCookie(){const e=s(this._cookieName);if(e){const t=JSON.parse(e);if((0,n.isValidIdentity)(t))return t;if((0,n.isOptoutIdentity)(t))return t;if(r(t))return this.migrateLegacyCookie(t,Date.now())}return null}}},220:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CstgBox=void 0;const r=i(28);class s{constructor(e,t){this._clientPublicKey=e,this._sharedKey=t}static build(e){return n(this,void 0,void 0,(function*(){const t=yield(0,r.generateKeyPair)(s._namedCurve),i=yield(0,r.importPublicKey)(e,this._namedCurve),n=yield(0,r.deriveKey)(i,t.privateKey);return new s(t.publicKey,n)}))}encrypt(e,t){return n(this,void 0,void 0,(function*(){const i=window.crypto.getRandomValues(new Uint8Array(12));return{iv:i,ciphertext:yield(0,r.encrypt)(e,this._sharedKey,i,t)}}))}decrypt(e,t){return n(this,void 0,void 0,(function*(){return yield(0,r.decrypt)(t,this._sharedKey,e)}))}get clientPublicKey(){return this._clientPublicKey}}t.CstgBox=s,s._namedCurve="P-256"},28:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.decrypt=t.encrypt=t.deriveKey=t.exportPublicKey=t.importPublicKey=t.generateKeyPair=void 0;const n=i(221);t.generateKeyPair=function(e){const t={name:"ECDH",namedCurve:e};return window.crypto.subtle.generateKey(t,!1,["deriveKey"])},t.importPublicKey=function(e,t){const i={name:"ECDH",namedCurve:t};return window.crypto.subtle.importKey("spki",(0,n.base64ToBytes)(e),i,!1,[])},t.exportPublicKey=function(e){return window.crypto.subtle.exportKey("spki",e)},t.deriveKey=function(e,t){return window.crypto.subtle.deriveKey({name:"ECDH",public:e},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])},t.encrypt=function(e,t,i,n){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:i,additionalData:n},t,e)},t.decrypt=function(e,t,i){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},t,e)}},597:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeEmail=t.isNormalizedPhone=void 0,t.isNormalizedPhone=function(e){return/^\+[0-9]{10,15}$/.test(e)},t.normalizeEmail=function(e){if(!e||!e.length)return;const t=e.trim().toLowerCase();if(t.indexOf(" ")>0)return;const i=function(e){const t=e.split("@");if(t.length&&2===t.length&&!t.some((e=>""===e)))return{address:t[0],domain:t[1]}}(t);if(!i)return;const{address:n,domain:r}=i,s=function(e){return"gmail.com"===e}(r),o=function(e,t,i){let n=e;return t&&(n=n.replaceAll(".","")),i&&(n=function(e,t="+"){return e.split(t)[0]}(n)),n}(n,s,s);return o?`${o}@${r}`:void 0}},221:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.bytesToBase64=t.base64ToBytes=void 0,t.base64ToBytes=function(e){const t=atob(e);return Uint8Array.from(t,(e=>e.codePointAt(0)))},t.bytesToBase64=function(e){const t=Array.from(e,(e=>String.fromCodePoint(e))).join("");return btoa(t)}},706:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hashIdentifier=t.hashAndEncodeIdentifier=void 0;const r=i(221);t.hashAndEncodeIdentifier=function(e){return n(this,void 0,void 0,(function*(){const t=yield window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return(0,r.bytesToBase64)(new Uint8Array(t))}))},t.hashIdentifier=function(e){return n(this,void 0,void 0,(function*(){const t=yield window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return[...new Uint8Array(t)].map((e=>e.toString(16).padStart(2,"0"))).join("")}))}},97:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),t.sdkWindow=t.__euidInternalHandleScriptLoad=t.assertEUID=t.EUID=void 0;const s=i(566),o=i(621),a=i(605);r(i(51),t);const l={name:"EUID",defaultBaseUrl:"https://prod.euid.eu",localStorageKey:"EUID-sdk-identity",cookieName:"__euid"};class d extends o.SdkBase{static get COOKIE_NAME(){return console.warn("Detected access to EUID.COOKIE_NAME. This is deprecated and will be removed in the future. Integrators should not access the cookie directly."),d.cookieName}static get EuidDetails(){return l}static setupGoogleTag(){d.setupGoogleSecureSignals()}static setupGoogleSecureSignals(){window.__euidSecureSignalProvider&&window.__euidSecureSignalProvider.registerSecureSignalProvider()}constructor(e=void 0,t={}){super(e,d.EuidDetails);const i=()=>{this._callbackManager.runCallbacks(s.EventType.SdkLoaded,{})};window.__euid instanceof d?i():t.callback=i}}function c(){var e;if(window.__euid&&"init"in window.__euid)return;const t=(null===(e=null===window||void 0===window?void 0:window.__euid)||void 0===e?void 0:e.callbacks)||[],i={};window.__euid=new d(t,i),window.__euidHelper=new o.UIDHelper,i.callback&&i.callback(),function(){if(window.__euid instanceof d){const e=(0,a.loadConfig)(l);e&&window.__euid.init(e)}}()}t.EUID=d,d.cookieName=l.cookieName,t.assertEUID=function(e){if(!(e instanceof d))throw new Error((0,o.sdkAssertErrorText)("EUID","assertEUID"))},t.__euidInternalHandleScriptLoad=c,c(),t.sdkWindow=globalThis.window},51:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isSDKOptionsOrThrow=t.isOptoutIdentity=t.isValidIdentity=t.SdkBase=t.hashIdentifier=t.hashAndEncodeIdentifier=t.isBase64Hash=t.normalizeEmail=t.isNormalizedPhone=t.isClientSideIdentityOptionsOrThrow=t.EventType=void 0;var n=i(566);Object.defineProperty(t,"EventType",{enumerable:!0,get:function(){return n.EventType}});var r=i(332);Object.defineProperty(t,"isClientSideIdentityOptionsOrThrow",{enumerable:!0,get:function(){return r.isClientSideIdentityOptionsOrThrow}});var s=i(597);Object.defineProperty(t,"isNormalizedPhone",{enumerable:!0,get:function(){return s.isNormalizedPhone}}),Object.defineProperty(t,"normalizeEmail",{enumerable:!0,get:function(){return s.normalizeEmail}});var o=i(357);Object.defineProperty(t,"isBase64Hash",{enumerable:!0,get:function(){return o.isBase64Hash}});var a=i(706);Object.defineProperty(t,"hashAndEncodeIdentifier",{enumerable:!0,get:function(){return a.hashAndEncodeIdentifier}}),Object.defineProperty(t,"hashIdentifier",{enumerable:!0,get:function(){return a.hashIdentifier}});var l=i(621);Object.defineProperty(t,"SdkBase",{enumerable:!0,get:function(){return l.SdkBase}});var d=i(480);Object.defineProperty(t,"isValidIdentity",{enumerable:!0,get:function(){return d.isValidIdentity}}),Object.defineProperty(t,"isOptoutIdentity",{enumerable:!0,get:function(){return d.isOptoutIdentity}});var c=i(64);Object.defineProperty(t,"isSDKOptionsOrThrow",{enumerable:!0,get:function(){return c.isSDKOptionsOrThrow}})},357:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isBase64Hash=void 0,t.isBase64Hash=function(e){if(!e||44!==e.length)return!1;try{return btoa(atob(e))===e}catch(e){return!1}}},18:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.InitCallbackManager=t.IdentityStatus=void 0,function(e){e[e.ESTABLISHED=0]="ESTABLISHED",e[e.REFRESHED=1]="REFRESHED",e[e.EXPIRED=100]="EXPIRED",e[e.NO_IDENTITY=-1]="NO_IDENTITY",e[e.INVALID=-2]="INVALID",e[e.REFRESH_EXPIRED=-3]="REFRESH_EXPIRED",e[e.OPTOUT=-4]="OPTOUT"}(i||(t.IdentityStatus=i={})),t.InitCallbackManager=class{constructor(e){this._initCallbacks=e.callback?[e.callback]:[]}addInitCallback(e){this._initCallbacks.push(e)}getInitCallbacks(){return this._initCallbacks}notifyInitCallbacks(e,t,i,n){this._initCallbacks.forEach((r=>{const s={advertisingToken:i,advertising_token:i,status:e,statusText:t};try{r(s)}catch(e){n.warn("SDK init callback threw an exception",e)}}))}}},819:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageManager=t.loadIdentityWithStorageKey=void 0;const n=i(480);function r(e){const t=function(e){return localStorage.getItem(e)}(e);if(t){const e=JSON.parse(t);if((0,n.isValidIdentity)(e))return e;if((0,n.isOptoutIdentity)(e))return e}return null}t.loadIdentityWithStorageKey=r,t.LocalStorageManager=class{constructor(e){this._storageKey=e}setValue(e){const t=JSON.stringify(e);localStorage.setItem(this._storageKey,t)}removeValue(){localStorage.removeItem(this._storageKey)}loadIdentityFromLocalStorage(){return r(this._storageKey)}}},697:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseHandler=void 0;const n=i(566);t.PromiseHandler=class{_handleEvent(e,t){e!==n.EventType.InitCompleted&&e!==n.EventType.IdentityUpdated||(e===n.EventType.InitCompleted&&(this._seenInitOrRejectAll=!0),this._apiClient&&this._apiClient.hasActiveRequests()||(this._promises.forEach((e=>{"identity"in t&&t.identity?e.resolve(t.identity.advertising_token):e.reject(new Error("No identity available."))})),this._promises=[]))}rejectAllPromises(e){this._seenInitOrRejectAll=!0,this._promises.forEach((t=>{t.reject(e)})),this._promises=[]}createMaybeDeferredPromise(e){return!this._seenInitOrRejectAll||this._apiClient&&this._apiClient.hasActiveRequests()?new Promise(((e,t)=>{this._promises.push({resolve:e,reject:t})})):e?Promise.resolve(e):Promise.reject(new Error("Identity not available"))}registerApiClient(e){this._apiClient=e}constructor(e){this._promises=[],this._seenInitOrRejectAll=!1,e.callbacks.push(this._handleEvent.bind(this))}}},7:(e,t)=>{function i(...e){}function n(e,t){const n=function(e){return"function"==typeof e?e:i}(e);return t?function(e,t){return(...i)=>{"string"==typeof i[0]?e(`[${t}] ${i[0]}`,...i.slice(1)):e(`[${t}]`,...i)}}(n,t):n}Object.defineProperty(t,"__esModule",{value:!0}),t.MakeLogger=void 0,t.MakeLogger=function(e,t){return{debug:n(e.debug,t),error:n(e.error,t),info:n(e.info,t),log:n(e.log,t),trace:n(e.trace,t),warn:n(e.warn,t)}}},621:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sdkAssertErrorText=t.SdkBase=t.UIDHelper=void 0;const r=i(330),s=i(480),o=i(18),a=i(64),l=i(7),d=i(31),c=i(566),u=i(332),h=i(597),p=i(357),y=i(697),f=i(178),g=i(706),_=i(605),v=i(305),b=i(819);function m(e,t=Date.now()){return e<=t}t.UIDHelper=class{normalizeEmail(e){return(0,h.normalizeEmail)(e)}hashIdentifier(e){return(0,g.hashIdentifier)(e)}hashAndEncodeIdentifier(e){return n(this,void 0,void 0,(function*(){return yield(0,g.hashAndEncodeIdentifier)(e)}))}isNormalizedPhone(e){return(0,h.isNormalizedPhone)(e)}};class I{static get VERSION(){return r.version}static get DEFAULT_REFRESH_RETRY_PERIOD_MS(){return 5e3}constructor(e,t){this.callbacks=[],this._opts={},this._initComplete=!1,this._refreshTimerId=null,this._product=t,this._logger=(0,l.MakeLogger)(console,t.name),e&&(this.callbacks=e),this._tokenPromiseHandler=new y.PromiseHandler(this),this._callbackManager=new c.CallbackManager(this,this._product.name,(()=>this.getIdentity()),this._logger)}init(e){this.initInternal(e)}setInitComplete(e){this._initComplete=e}getAdvertisingToken(){var e,t;return null!==(t=null===(e=this.getIdentity())||void 0===e?void 0:e.advertising_token)&&void 0!==t?t:void 0}setIdentityFromEmail(e,t){return n(this,void 0,void 0,(function*(){if(this._logger.log("Sending request",e),this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,u.isClientSideIdentityOptionsOrThrow)(t,this._product.name),void 0===(0,h.normalizeEmail)(e))throw new Error("Invalid email address");const i=yield(0,g.hashAndEncodeIdentifier)(e);yield this.callCstgAndSetIdentity({emailHash:i},t)}))}setIdentityFromEmailHash(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,u.isClientSideIdentityOptionsOrThrow)(t,this._product.name),!(0,p.isBase64Hash)(e))throw new Error("Invalid hash");yield this.callCstgAndSetIdentity({emailHash:e},t)}))}setIdentityFromPhone(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,u.isClientSideIdentityOptionsOrThrow)(t,this._product.name),!(0,h.isNormalizedPhone)(e))throw new Error("Invalid phone number");const i=yield(0,g.hashAndEncodeIdentifier)(e);yield this.callCstgAndSetIdentity({phoneHash:i},t)}))}setIdentityFromPhoneHash(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,u.isClientSideIdentityOptionsOrThrow)(t,this._product.name),!(0,p.isBase64Hash)(e))throw new Error("Invalid hash");yield this.callCstgAndSetIdentity({phoneHash:e},t)}))}setIdentity(e){this._apiClient&&this._apiClient.abortActiveRequests();const t=this.validateAndSetIdentity(e);t&&((0,s.isOptoutIdentity)(t)?this._callbackManager.runCallbacks(c.EventType.OptoutReceived,{}):this.triggerRefreshOrSetTimer(t),this._callbackManager.runCallbacks(c.EventType.IdentityUpdated,{}))}getIdentity(){var e;const t=null!==(e=this._identity)&&void 0!==e?e:this.getIdentityNoInit();return!t||this.temporarilyUnavailable(t)||(0,s.isOptoutIdentity)(t)?null:t}getAdvertisingTokenAsync(){const e=this.getAdvertisingToken();return this._tokenPromiseHandler.createMaybeDeferredPromise(null!=e?e:null)}isInitComplete(){return this._initComplete}isLoginRequired(){return this.hasIdentity()}hasIdentity(){var e;if(this._initComplete)return!(this.isLoggedIn()||(null===(e=this._apiClient)||void 0===e?void 0:e.hasActiveRequests()))}hasOptedOut(){if(this._initComplete)return(0,s.isOptoutIdentity)(this._identity)}disconnect(){this.abort(`${this._product.name} SDK disconnected.`),this._storageManager?this._storageManager.removeValues():new f.StorageManager({},this._product.cookieName,this._product.localStorageKey).removeValues(),this._identity=void 0,this._callbackManager.runCallbacks(c.EventType.IdentityUpdated,{identity:null})}abort(e){this._tokenPromiseHandler.rejectAllPromises(null!=e?e:new Error(`${this._product.name} SDK aborted.`)),this._refreshTimerId&&(clearTimeout(this._refreshTimerId),this._refreshTimerId=null),this._apiClient&&this._apiClient.abortActiveRequests()}initInternal(e){var t,i,n,r,s;if(!(0,a.isSDKOptionsOrThrow)(e))throw new TypeError(`Options provided to ${this._product.name} init couldn't be validated.`);if(this.isInitComplete()){const s=Object.assign({},this._opts);Object.assign(this._opts,e),e.baseUrl&&e.baseUrl!==s.baseUrl&&(null===(t=this._apiClient)||void 0===t||t.updateBaseUrl(e.baseUrl),this._logger.log("BaseUrl updated for ApiClient")),e.callback&&e.callback!==s.callback&&(null===(i=this._initCallbackManager)||void 0===i||i.addInitCallback(e.callback),this._logger.log("init callback added to list"));const o=e.identity&&(!s.identity||e.identity.identity_expires>s.identity.identity_expires);if(o||e.callback){let t=o?e.identity:null!==(n=s.identity)&&void 0!==n?n:null;t&&this.handleNewIdentity(t)}e.refreshRetryPeriod&&s.refreshRetryPeriod!==e.refreshRetryPeriod&&(this.setRefreshTimer(),this._logger.log("new refresh period set and refresh timer set")),(0,_.updateConfig)(this._opts,this._product,s),this._storageManager=new f.StorageManager(this._opts,this._product.cookieName,this._product.localStorageKey),null===(r=this._storageManager)||void 0===r||r.updateValue(this._opts,this._product.cookieName,s)}else{let t;(0,_.storeConfig)(e,this._product),this._opts=e,this._storageManager=new f.StorageManager(Object.assign({},e),this._product.cookieName,this._product.localStorageKey),this._apiClient=new d.ApiClient(e,this._product.defaultBaseUrl,this._product.name),this._tokenPromiseHandler.registerApiClient(this._apiClient),this._initCallbackManager=new o.InitCallbackManager(e),t=this._opts.identity?this._opts.identity:this._storageManager.loadIdentityWithFallback(),this.handleNewIdentity(t)}this.setInitComplete(!0),null===(s=this._callbackManager)||void 0===s||s.runCallbacks(c.EventType.InitCompleted,{}),this.hasOptedOut()&&this._callbackManager.runCallbacks(c.EventType.OptoutReceived,{})}isLoggedIn(){return this._identity&&!m(this._identity.refresh_expires)}temporarilyUnavailable(e){var t;return!(e||!(null===(t=this._apiClient)||void 0===t?void 0:t.hasActiveRequests()))||!(!e||!m(e.identity_expires)||m(e.refresh_expires))}getIdentityStatus(e){return e?(0,s.isOptoutIdentity)(e)?{valid:!1,errorMessage:"User has opted out",status:o.IdentityStatus.OPTOUT,identity:e}:e.advertising_token?e.refresh_token?m(e.refresh_expires,Date.now())?{valid:!1,errorMessage:"Identity expired, refresh expired",status:o.IdentityStatus.REFRESH_EXPIRED,identity:null}:m(e.identity_expires,Date.now())?{valid:!0,errorMessage:"Identity expired, refresh still valid",status:o.IdentityStatus.EXPIRED,identity:e}:void 0===this._identity?{valid:!0,identity:e,status:o.IdentityStatus.ESTABLISHED,errorMessage:"Identity established"}:{valid:!0,identity:e,status:o.IdentityStatus.REFRESHED,errorMessage:"Identity refreshed"}:{valid:!1,errorMessage:"refresh_token is not available or is not valid",status:o.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"advertising_token is not available or is not valid",status:o.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"Identity not available",status:o.IdentityStatus.NO_IDENTITY,identity:null}}validateAndSetIdentity(e,t,i){var n,r,a;if(!this._storageManager)throw new Error("Cannot set identity before calling init.");const l=this.getIdentityStatus(e);return l.valid&&l.identity&&!(0,s.isOptoutIdentity)(this._identity)&&(null===(n=l.identity)||void 0===n?void 0:n.advertising_token)===(null===(r=this._identity)||void 0===r?void 0:r.advertising_token)||(l.valid&&l.identity?this._storageManager.setIdentity(l.identity):l.status===o.IdentityStatus.OPTOUT||t===o.IdentityStatus.OPTOUT?this._storageManager.setOptout():(this.abort(),this._storageManager.removeValues()),this._identity=this._storageManager.loadIdentity(),null===(a=this._initCallbackManager)||void 0===a||a.notifyInitCallbacks(null!=t?t:l.status,null!=i?i:l.errorMessage,this.getAdvertisingToken(),this._logger)),l.identity}triggerRefreshOrSetTimer(e){m(e.refresh_from,Date.now())?this.refreshToken(e):this.setRefreshTimer()}handleNewIdentity(e){const t=this.validateAndSetIdentity(e);t&&!(0,s.isOptoutIdentity)(t)&&this.triggerRefreshOrSetTimer(t)}setRefreshTimer(){var e,t;const i=null!==(t=null===(e=this._opts)||void 0===e?void 0:e.refreshRetryPeriod)&&void 0!==t?t:I.DEFAULT_REFRESH_RETRY_PERIOD_MS;this._refreshTimerId&&clearTimeout(this._refreshTimerId),this._refreshTimerId=setTimeout((()=>{var e,t;if(this.isLoginRequired())return;const i=this.validateAndSetIdentity(null!==(t=null===(e=this._storageManager)||void 0===e?void 0:e.loadIdentity())&&void 0!==t?t:null);i&&!(0,s.isOptoutIdentity)(i)&&this.triggerRefreshOrSetTimer(i),this._refreshTimerId=null}),i)}refreshToken(e){const t=this._apiClient;if(!t)throw new Error("Cannot refresh the token before calling init.");t.callRefreshApi(e).then((e=>{switch(e.status){case"success":this.validateAndSetIdentity(e.identity,o.IdentityStatus.REFRESHED,"Identity refreshed"),this.setRefreshTimer();break;case"optout":this.validateAndSetIdentity(null,o.IdentityStatus.OPTOUT,"User opted out"),this._callbackManager.runCallbacks(c.EventType.OptoutReceived,{});break;case"expired_token":this.validateAndSetIdentity(null,o.IdentityStatus.REFRESH_EXPIRED,"Refresh token expired")}}),(t=>{this._logger.warn("Encountered an error refreshing the token",t),this.validateAndSetIdentity(e),m(e.refresh_expires,Date.now())||this.setRefreshTimer()})).then((()=>{this._callbackManager.runCallbacks(c.EventType.IdentityUpdated,{})}),(e=>this._logger.warn("Callbacks on identity event failed.",e)))}getIdentityNoInit(){var e;return null!==(e=(0,v.loadIdentityFromCookieNoLegacy)(this._product.cookieName))&&void 0!==e?e:(0,b.loadIdentityWithStorageKey)(this._product.localStorageKey)}callCstgAndSetIdentity(e,t){return n(this,void 0,void 0,(function*(){const i=yield this._apiClient.callCstgApi(e,t);if("success"==i.status)this.setIdentity(i.identity);else{if("optout"!==i.status){const e="Unexpected status received from CSTG endpoint.";throw this._logger.warn(e),new Error(e)}this.validateAndSetIdentity(null,o.IdentityStatus.OPTOUT),this._callbackManager.runCallbacks(c.EventType.OptoutReceived,{}),this._callbackManager.runCallbacks(c.EventType.IdentityUpdated,{})}}))}throwIfInitNotComplete(e){if(!this._initComplete)throw new Error(e)}}t.SdkBase=I,I.IdentityStatus=o.IdentityStatus,I.EventType=c.EventType,t.sdkAssertErrorText=function(e,t){return`Assertion failed: the provided value is not an instance of ${e}. Have you called ${t} from outside a callback function?`}},64:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isSDKOptionsOrThrow=void 0,t.isSDKOptionsOrThrow=function(e){if("object"!=typeof e||null===e)throw new TypeError("opts must be an object");const t=e;if(void 0!==t.callback&&"function"!=typeof t.callback)throw new TypeError("opts.callback, if provided, must be a function");if(void 0!==t.refreshRetryPeriod){if("number"!=typeof t.refreshRetryPeriod)throw new TypeError("opts.refreshRetryPeriod must be a number");if(t.refreshRetryPeriod<1e3)throw new RangeError("opts.refreshRetryPeriod must be >= 1000")}return!0}},178:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StorageManager=void 0;const n=i(305),r=i(819);t.StorageManager=class{constructor(e,t,i){this._opts=e,this._cookieManager=new n.CookieManager(Object.assign({},e),t),this._localStorageManager=new r.LocalStorageManager(i)}loadIdentityWithFallback(){const e=this._localStorageManager.loadIdentityFromLocalStorage(),t=this._cookieManager.loadIdentityFromCookie();return t&&(!e||t.identity_expires>e.identity_expires)?t:e}loadIdentity(){var e;return null!==(e=this._cookieManager.loadIdentityFromCookie())&&void 0!==e?e:this._localStorageManager.loadIdentityFromLocalStorage()}setIdentity(e){this.setValue(e)}updateValue(e,t,i){e.identity&&(!0===i.useCookie?this._cookieManager.removeCookie(i):i&&!1!==i.useCookie||this._localStorageManager.removeValue(),this._cookieManager=new n.CookieManager(Object.assign({},e),t),this.setValue(e.identity))}setOptout(){const e=Date.now()+2592e5,t={refresh_expires:e,identity_expires:e,status:"optout"};this.setValue(t)}setValue(e){this._opts.useCookie?this._cookieManager.setCookie(e):(this._localStorageManager.setValue(e),this._localStorageManager.loadIdentityFromLocalStorage()&&this._cookieManager.removeCookie(this._opts))}removeValues(){this._cookieManager.removeCookie(this._opts),this._localStorageManager.removeValue()}}},330:e=>{e.exports=JSON.parse('{"name":"@uid2/uid2-sdk","version":"3.8.0","description":"UID2 Client SDK","author":"The Trade Desk","repository":{"type":"git","url":"git+https://github.com/iabtechlab/uid2-web-integrations.git"},"license":"Apache 2.0","wallaby":{"delays":{"run":1000}},"scripts":{"lint":"eslint -c .eslintrc.js . ../static/js/uid2-sdk-2.0.0.js ../static/js/uid2-sdk-1.0.0.js","test":"jest","build":"webpack","build-with-sourcemaps":"webpack --mode=production --env prodSourceMaps=true","build-package":"unbuild","watch":"webpack watch --mode=development","webpack-dev-server":"webpack-dev-server --config webpack-dev-server.config.js --hot --port 9091","uid2-examples":"webpack --mode=development --env outputToExamples=true","build:esp":"webpack --env espOnly=true","createCA":"tsx createCA.ts","localtest":"cd localtest && tsx server.ts"},"engines":{"node":">=18"},"jest":{"preset":"ts-jest","testEnvironment":"jsdom","setupFilesAfterEnv":["./setupJest.js"],"testPathIgnorePatterns":["/node_modules/","/dist/"]},"devDependencies":{"@jest/globals":"^29.2.2","@types/jest":"^29.2.0","@types/node":"^18.11.3","@types/react":"^18.3.9","@types/react-dom":"^18.3.0","@typescript-eslint/eslint-plugin":"^5.40.1","@typescript-eslint/parser":"^5.40.1","css-loader":"^7.1.2","eslint":"^8.25.0","eslint-config-airbnb-typescript":"^17.0.0","eslint-plugin-import":"^2.26.0","eslint-plugin-promise":"^6.1.1","eslint-plugin-simple-import-sort":"^8.0.0","eslint-plugin-testing-library":"^5.9.0","html-bundler-webpack-plugin":"^4.0.0","jest":"^29.2.1","jest-environment-jsdom":"^29.2.1","jsdom":"^20.0.1","mkcert":"^3.2.0","react":"^18.3.1","react-dom":"^18.3.1","sass":"^1.79.3","sass-loader":"^16.0.2","ts-jest":"^29.0.3","ts-loader":"^9.4.1","tsx":"^4.19.1","typescript":"^5.4.5","unbuild":"^2.0.0","webpack":"^5.95.0","webpack-cli":"^5.1.4","webpack-dev-server":"^5.1.0"}}')}},t={};!function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(97)})();